#!/bin/sh -e
#
# TODO:
#
# * Make it generate a new version number.
# * Set a tag in git.
# * Generate a rockspec.
# * Upload the tarball to github.
# * Announce

# 시맨틱 버전 패턴(vMAJOR.MINOR.PATCH 또는 MAJOR.MINOR.PATCH)만 필터링하여 최신 태그 가져오기
version=$(git tag --sort=-v:refname | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+$' | head -1)

# 버전이 비어있으면 에러 메시지 출력 후 종료
if [ -z "$version" ]; then
    echo "Error: No semantic version tags found. Please create a version tag (e.g., v1.0.0 or 1.0.0) first."
    exit 1
fi

name="lua-websockets-$version"

# TMPDIR 환경변수 확인 후 없으면 안전한 임시 디렉토리 생성
tmp="$TMPDIR"
if [ -z "$tmp" ]; then
   tmp=$(mktemp -d 2>/dev/null || mktemp -d -t 'lua-websockets')
fi

src="$(cd "$(dirname "$0")" && pwd)"

cd "$tmp"
rm -f "$name"
ln -sf "$src" "$name"

echo "Creating $tmp/$name.tar.gz"
tar -czvpf "$name.tar.gz" \
    --dereference \
    --exclude "$name/.git*" \
    --exclude "$name/*.o" \
    --exclude "$name/*.so" \
    --exclude "$name/lua-websockets.rockspec" \
    --exclude "$name/rockspecs" \
    --exclude "$name/$(basename "$0")" \
    "$name"
echo "Creating $tmp/$name-1.rockspec"
cat "$src/lua-websockets.rockspec" | \
    sed s/@VERSION@/$version/ > \
    "$name-1.rockspec"
